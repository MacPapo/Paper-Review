{% extends "base.html" %}
{% from "form_components/_render_field.html" import render_multiple_file_field %}

{% block content %}
<section class="py-4 py-md-5 my-5">
    <div class="container py-md-5">
        <div class="row">
            <div class="mb-3">
                <h2 class="display-8 fw-bold mb-2">Edit project <span class="badge bg-warning text-dark">Draft</span></h2>
                <p class="display-8 mb-5">Please provide a title, a descriprion and as many PDFs you desire.</p>

                <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                    {{ form.hidden_tag() }}


                    <div class="form-group mb-4">
                        {{ form.title(class="form-control", placeholder="Title", id="title", required=True) }}
                        <div class="invalid-feedback">
                            Please provide a valid title.
                        </div>
                    </div>
                    <div class="form-group mb-4">
                        {{ form.description(class="form-control", placeholder="Description", id="description", rows="7", required=True) }}
                        <div class="invalid-feedback">
                            Please provide a valid description.
                        </div>
                    </div>

                    <!-- Add pdfs -->

                    <table id="file-fields" class="table table-sm">
                        <tbody>
                            {% for link, name in pdfs.items() %}

                                <tr class="text-center">

                                    <th scope="row">
                                        <label for="file-{{ loop.index }}"><b>{{ loop.index }} </b></label>
                                    </th>
                                    <td scope="row">
                                        {% if name %}
                                        <input style="border: none; width: 100%;text-align:center;" class="existing-name" type="text" id="name-{{ loop.index }}" name="names"
                                            value="{{ name }}" readonly>
                                        {% else %}
                                        <input style="border: none; width: 100%;text-align:center;" type="file" id="file-{{ loop.index }}" name="files" readonly>
                                        {% endif %}
                                    </td>
                                    <td scope="row">
                                        <div class="d-flex justify-content-end">
                                        <button class="btn btn-danger" id="remove-file-btn" type="button">-</button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <div class="d-flex justify-content-center align-items-centerd-flex justify-content-center align-items-center mt-3">
                    <button  class="btn btn-primary" id="add-file-btn" type="button">+</button>
                    </div>
                    <br><br>
                    <div class="row">
                        <div class="col-sm">
                        <button class="btn btn-danger btn-block " id="discard-draft" type="button">Discard Draft</button>
                        </div>
                        <div class="col-sm">
                            <div class="d-flex justify-content-end">
                        <button class="btn btn-light btn-block " id="submit-draft" type="button">Submit Draft</button>
                            </div>
                        </div>
                        <div class="col-sm">
                        <button class="btn btn-primary btn-block" id="submit-project" type="button">Apply Draft To Project</button>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript">
 $(document).ready(function() {

     // Retrieve project data from the server-side template variable
     var fileCount = {{ counter}};

     $('#add-file-btn').click(function(e) {
         e.preventDefault();

         var fileField = $('<tr class="text-center">' +
                           '<th scopre="row"><label for="file-' + (fileCount+1) + '"></th><td scope="row">PDF File ' + (fileCount+1) + ':   </label>' +
                           '<input  type="file" id="file-' + (fileCount+1) + '" name="files"></td><td scope="row"><div class="d-flex justify-content-end">' +
                           '<button class="btn btn-danger" id="remove-file-btn" type="button">-</button></div></td>' +
                           '</tr>');

         $('#file-fields').append(fileField);
                ++fileCount;
     });

     $('#file-fields').on('click', '#remove-file-btn', function(e) {
         e.preventDefault();

         $(this).closest('tr').remove();

     });

     $('#submit-draft').click(function(e) {
         e.preventDefault();

         var title = $('#title').val();
         var description = $('#description').val();
         var names = $('#input[name="names"]');
         var files = $('input[name="files"]');

         // Todo
         // Check if at least one file is selected
         // if (names.length === 0 && files.length === 0) {
         //     alert('Please upload at least one file.');
         //     return;
         // }
         //

         var formData = new FormData();
         formData.append('title', title);
         formData.append('description', description);

         $('.existing-name').each(function() {
             var name = $(this).val() + '.pdf';
             console.log(name)
             formData.append('names', name);
         });

         for (var i = 0; i < files.length; i++) {
             formData.append('files', files[i].files[0]);
         }

         $.ajax({
             url: "{{ url_for('project.edit_draft', vid=vid) }}",
             type: 'POST',
             data: formData,
             contentType: false,
             processData: false,
             success: function(response) {
                 alert('Form submitted successfully!');
                 window.location.href = "{{ url_for('project.edit', vid=vid) }}";
             },
             error: function(error) {
                 alert('Error submitting the form. Please try again.');
                 console.log(error);
             }
         });
     });


     $('#submit-project').click(function(e) {
         e.preventDefault();

         var title = $('#title').val();
         var description = $('#description').val();
         var names = $('#input[name="names"]');
         var files = $('input[name="files"]');

         // Todo
         // Check if at least one file is selected
         // if (names.length === 0 && files.length === 0) {
         //     alert('Please upload at least one file.');
         //     return;
         // }
         //

         var formData = new FormData();
         formData.append('title', title);
         formData.append('description', description);

         $('.existing-name').each(function() {
             var name = $(this).val() + '.pdf';
             console.log(name)
             formData.append('names', name);
         });

         for (var i = 0; i < files.length; i++) {
             formData.append('files', files[i].files[0]);
         }

         $.ajax({
             url: "{{ url_for('project.edit_draft', vid=vid) }}",
             type: 'POST',
             data: formData,
             contentType: false,
             processData: false,
             success: function(response) {
                 // Perform the second POST request
                 $.ajax({
                     url: "{{ url_for('project.update_version', vid=vid) }}",
                     type: 'POST',
                     success: function(response) {
                         // Handle the success of the second POST request
                         alert('Request submitted successfully!');
                         window.location.href = "{{ url_for('project.projects') }}";
                     },
                     error: function(error) {
                         // Handle the error of the second POST request
                         alert('Error submitting the second request. Please try again.');
                         console.log(error);
                     }
                 });
             },
             error: function(error) {
                 alert('Error submitting the form. Please try again.');
                 console.log(error);
             }
         });
     });

     $('#discard-draft').click(function(e) {
         e.preventDefault();

         $.ajax({
             url: "{{ url_for('project.discard_draft', vid=vid) }}",
             type: 'POST',
             contentType: false,
             processData: false,
             success: function(response) {
                 alert('Draft discarded successfully!');
                 window.location.href = "{{ url_for('project.edit', vid=vid) }}";
             },
             error: function(error) {
                 alert('Error submitting the form. Please try again.');
                 console.log(error);
             }
         });
     });
 });
</script>
{% endblock %}
